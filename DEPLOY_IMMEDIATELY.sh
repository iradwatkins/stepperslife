#!/bin/bash

# IMMEDIATE DEPLOYMENT COMMAND
# Run this to deploy right now while we fix GitHub Actions

echo "ðŸš€ IMMEDIATE DEPLOYMENT SCRIPT"
echo "============================"
echo ""
echo "Copy and run this ENTIRE command:"
echo ""
echo "ssh root@72.60.28.175 << 'EOF'"
echo "echo 'Connected to server...'"
echo ""
echo "# Check if container exists"
echo "if docker ps -a | grep -q stepperslife-prod; then"
echo "  echo 'Stopping existing container...'"
echo "  docker stop stepperslife-prod"
echo "  docker rm stepperslife-prod"
echo "fi"
echo ""
echo "# Clear port 3000"
echo "docker stop \$(docker ps -q --filter 'publish=3000') 2>/dev/null || true"
echo ""
echo "# Get latest code"
echo "cd /opt"
echo "rm -rf stepperslife"
echo "git clone https://github.com/iradwatkins/stepperslife.git"
echo "cd stepperslife"
echo ""
echo "# Configure build"
echo "cat > next.config.js << 'NEXTEOF'"
echo "const nextConfig = {"
echo "  eslint: { ignoreDuringBuilds: true },"
echo "  typescript: { ignoreBuildErrors: true },"
echo "  output: 'standalone',"
echo "  images: { remotePatterns: [{ protocol: 'https', hostname: '**' }] }"
echo "}"
echo "module.exports = nextConfig"
echo "NEXTEOF"
echo ""
echo "# Build image"
echo "echo 'Building Docker image (this takes 3-5 minutes)...'"
echo "docker build -t stepperslife:latest ."
echo ""
echo "# Run with all environment variables"
echo "echo 'Starting container with environment variables...'"
echo "docker run -d \\\\"
echo "  --name stepperslife-prod \\\\"
echo "  --restart unless-stopped \\\\"
echo "  --network coolify \\\\"
echo "  -p 3000:3000 \\\\"
echo "  -e NODE_ENV=production \\\\"
echo "  -e PLATFORM_FEE_PER_TICKET=1.50 \\\\"
echo "  -e NEXTAUTH_URL=https://stepperslife.com \\\\"
echo "  -e NEXTAUTH_SECRET=MNPqnyyK7CDiaLwgHQEj+cpt0miM03ff0ECPxl5VKdc= \\\\"
echo "  -e GOOGLE_CLIENT_ID=1009301533734-s9lbcqhrhehvtmd2bbrpkuvf4oo7ov3v.apps.googleusercontent.com \\\\"
echo "  -e GOOGLE_CLIENT_SECRET=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 \\\\"
echo "  -e NEXT_PUBLIC_CONVEX_URL=https://mild-newt-621.convex.cloud \\\\"
echo "  -e CONVEX_DEPLOYMENT=prod:mild-newt-621 \\\\"
echo "  -e NEXT_PUBLIC_APP_URL=https://stepperslife.com \\\\"
echo "  -e NEXT_PUBLIC_APP_NAME=SteppersLife \\\\"
echo "  -e NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=AIzaSyAD1jQHxD0Y7TfZzv8D8V7o7DfwB7CjJxE \\\\"
echo "  -e DATABASE_URL='file:./dev.db' \\\\"
echo "  --label 'traefik.enable=true' \\\\"
echo "  --label 'traefik.http.routers.stepperslife.rule=Host(\\\`stepperslife.com\\\`)' \\\\"
echo "  --label 'traefik.http.services.stepperslife.loadbalancer.server.port=3000' \\\\"
echo "  stepperslife:latest"
echo ""
echo "# Verify"
echo "sleep 10"
echo "echo ''"
echo "echo 'Checking deployment...'"
echo "docker ps | grep stepperslife"
echo "echo ''"
echo "echo 'Testing API...'"
echo "curl -s http://localhost:3000/api/auth/providers | grep google"
echo "echo ''"
echo "echo 'âœ… Deployment complete!'"
echo "EOF"